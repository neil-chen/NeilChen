<?php

/**
 * @file
 * Install, update, and uninstall functions for Covidien Users module.
 */
function covidien_users_install() {
  db_query("UPDATE {system} SET weight = 2 WHERE type = 'module' AND name = 'covidien_users'");
  $files = file_scan_directory(drupal_get_path('module', 'covidien_users') . '/content_type', '.cck_import.inc');
  foreach ($files as $absolute => $file) {
    $form_state = array();
    $form_state['values']['type_name'] = '<create>';
    $fh = fopen($file->filename, 'r');
    $thedata = fread($fh, filesize($file->filename));
    fclose($fh);
    $form_state['values']['macro'] = "$thedata";
    drupal_execute('content_copy_import_form', $form_state);
  }
  drupal_install_schema('covidien_users');
}

// Uninstall Instruction
function covidien_users_uninstall() {
  
}

function covidien_users_schema() {
  $schema['user_sessions'] = array(
    'description' => " Closely connected to the Drupal's session handlers table.",
    'fields' => array(
      'uid' => array(
        'description' => 'The {users}.uid corresponding to a session, or 0 for anonymous user.',
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE),
      'sid' => array(
        'description' => "Primary key: A session ID. The value is generated by PHP's Session API.",
        'type' => 'varchar',
        'length' => 64,
        'not null' => TRUE,
        'default' => ''),
      'session_status' => array(
        'description' => 'Session status. ',
        'type' => 'varchar',
        'length' => 128,
        'not null' => FALSE,
        'default' => ''),
      'is_active' => array(
        'description' => 'Whether the session status is active or not ',
        'type' => 'int',
        'not null' => FALSE,
        'default' => 0)
    ),
    'primary key' => array('sid'),
    'indexes' => array(
      'session_status' => array('session_status'),
      'uid' => array('uid')
    ),
  );

  return $schema;
}

function covidien_users_update_6001() {
  $ret = array();

  $user_array = array('system1@gmail.com' => 'vent.admin@covidien.com', 'system2@gmail.com' => 'ebd.admin@covidien.com');
  foreach ($user_array as $key => $val) {
    $userid = db_result(db_query("select uid from {users} where name = '%s'", $key));
    $node_id = db_result(db_query("select nid from {node} where title = '%s' and type='%s'", $key, 'person'));

    if (!empty($userid) && (!empty($node_id))) {
      update_sql("Update {users} set name = '$val', mail = '$val', init = '$val' where uid = '$userid'");

      update_sql("Update {content_type_person} set field_person_username_value = '$val' where nid = ' $node_id'");
      update_sql("Update {node} set title = '$val' where title = '$key'");

      $val2 = new stdClass();
      $val2->title = $val;
      $val2->type = "user_settings";
      $val2->uid = $userid;
      $val2->language = "en";
      $val2->field_email_notifications[0]['nid'] = '';
      $val2->field_user_language[0]['nid'] = '';
      node_save($val2);


      $val2 = new stdClass();
      $val2->title = $val;
      $val2->type = "device_notification_subscription";
      $val2->uid = $userid;
      $val2->language = "en";
      $val2->field_person[] = array('nid' => $node_id);
      $val2->field_device_notification_type[0]['nid'] = '';

      node_save($val2);
    }
  }
  return $ret;
}

function covidien_users_update_6002() {
  $ret = array();

  global $drupal_password_expiration_day;
  $date = time() + ($drupal_password_expiration_day * (24 * 3600));
  $datesql = format_date($date, 'custom', 'Y-m-d H:i:s', 0);

  update_sql("Update {content_type_person} set field_password_expiration_date_value = '$datesql' where field_password_expiration_date_value IS NULL");

  $user_array = array('vent.admin@covidien.com', 'ebd.admin@covidien.com');
  foreach ($user_array as $val) {
    $node_id = db_result(db_query("select nid from {node} where title = '%s' and type='person'", $val));

    if (!empty($node_id)) {
      update_sql("Update {content_field_expiration_datetime} set field_expiration_datetime_value = '0000-00-00 00:00:00' where nid = '$node_id' and field_expiration_datetime_value IS NULL");
    }
  }


  return $ret;
}

function covidien_users_update_6003() {
  $ret = array();
  $user_array = array('vent.admin@covidien.com' => 'VENTadmin@123', 'ebd.admin@covidien.com' => 'EBDadmin@123');
  foreach ($user_array as $key => $val) {
    $pass = db_result(db_query("select pass from {users} where name = '%s'", $key));
    if ($pass != md5($val)) {
      update_sql("Update {users} set pass = '" . md5($val) . "' where name = '$key'");
    }
  }
  return $ret;
}

/**
 * Sprint 8 - New Notification added 'Device update' also updated in hook_install
 */
function covidien_users_update_6004() {
  $ret = array();

  $user_array = array('vent.admin@covidien.com', 'ebd.admin@covidien.com');
  foreach ($user_array as $key) {
    $userid = db_result(db_query("select uid from {users} where name = '%s'", $key));
    $node_id = db_result(db_query("select nid from {node} where title = '%s' and type='person'", $key));

    if (!empty($userid) && (!empty($node_id))) {
      $status_id = db_result(db_query("select nid from {node} where title = '%s' and type='user_settings'", $key));
      if (empty($status_id)) {
        $val2 = new stdClass();
        $val2->title = $key;
        $val2->type = "user_settings";
        $val2->uid = $userid;
        $val2->language = "en";
        $val2->field_email_notifications[0]['nid'] = '';
        $val2->field_user_language[0]['nid'] = '';
        node_save($val2);


        $val2 = new stdClass();
        $val2->title = $key;
        $val2->type = "device_notification_subscription";
        $val2->uid = $userid;
        $val2->language = "en";
        $val2->field_person[] = array('nid' => $node_id);
        $val2->field_device_notification_type[0]['nid'] = '';

        node_save($val2);
      }
    }
  }

  $nid = db_result(db_query("SELECT nid FROM node WHERE type='device_notification_type' AND title='%s'", 'Device update'));
  if (!$nid) {
    $node = new stdClass();
    $node->type = 'device_notification_type';
    $node->uid = 1;
    $node->format = 0;
    $node->title = 'Device update';
    $node->field_sort_sequence[0]['value'] = 6;
    node_save($node);
  }

  return $ret;
}

/**
 * Implements hook_update
 * March 2013
 * for i17
 */
function covidien_users_update_6005() {
  module_load_include('php', 'covidien_ui', 'includes/content_copy_import_update');
  $ret = array();
  /**
   * Users modules CCK update.
   */
  // List of new content types to import.
  //$import_new = array('sample.cck_import');
  $import_new = array();
  //Example 'contenttype.cck_import'
  // List of content types to update.
  $import_updatearr = array(
    'person_application_role.cck_import' => 'person_application_role',
  );
  // For delete action update the update action array also.
  $import_deletearr = array();
  //Example 'contenttype.cck_import'=>array('field_one'), 
  $arg = array(
    'module_name' => 'covidien_users',
    'import_new' => $import_new,
    'import_updatearr' => $import_updatearr,
    'import_deletearr' => $import_deletearr,
  );
  covidien_contenttype_update($arg);
  return $ret;
}

/**
 * Notes:
 * hook_update implemented in covidien_sampledata module
 * covidien_sampledata_update_6006
 * April 2013
 */

/**
 * Implements hook_update
 * for Phase 2
 */
function covidien_users_update_6100() {
  $ret = array();
  module_load_include('php', 'covidien_ui', 'includes/content_copy_import_update');
  /**
   * Users modules CCK update.
   */
  // List of new content types to import.
  //$import_new = array('sample.cck_import');
  $import_new = array();
  //Example 'contenttype.cck_import'
  // List of content types to update.
  $import_updatearr = array(
    'person.cck_import' => 'person',
  );
  // For delete action update the update action array also.
  $import_deletearr = array();
  //Example 'contenttype.cck_import'=>array('field_one'), 
  $arg = array(
    'module_name' => 'covidien_users',
    'import_new' => $import_new,
    'import_updatearr' => $import_updatearr,
    'import_deletearr' => $import_deletearr,
  );
  covidien_contenttype_update($arg);

  return $ret;
}

function covidien_users_update_6101() {
  $ret = array();
  db_add_index($ret, 'activity_log', 'nid', array('nid'));
  db_add_index($ret, 'activity_log', 'logtime', array('logtime'));
  db_add_index($ret, 'activity_log', 'device', array('device'));
  db_add_index($ret, 'activity_log', 'device_serial', array('device_serial'));
  return $ret;
}
